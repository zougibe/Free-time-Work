<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stunt Sequence Designer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700&display=swap');

        :root {
            /* Light Mode Variables */
            --primary-light: #1a1a2e;
            --secondary-light: #ff4757;
            --accent-light: #00a8ff;
            --light-light: #f1f2f6;
            --dark-light: #0f3460;
            --card-bg-light: rgba(26, 26, 46, 0.8);
            --timeline-bg-light: rgba(15, 52, 96, 0.8);
            --success-light: #2ecc71;
            --warning-light: #f39c12;
            --danger-light: #ff4757;
            --text-light: #f1f2f6;
            --bg-gradient-light: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            --preview-bg-light: linear-gradient(135deg, rgba(44, 62, 80, 0.3) 0%, rgba(26, 26, 46, 0.3) 100%);

            /* Dark Mode Variables */
            --primary-dark: #121212;
            --secondary-dark: #e91e63;
            --accent-dark: #03a9f4;
            --light-dark: #e0e0e0;
            --dark-dark: #1c2526;
            --card-bg-dark: rgba(18, 18, 18, 0.9);
            --timeline-bg-dark: rgba(28, 37, 38, 0.9);
            --success-dark: #4caf50;
            --warning-dark: #ff9800;
            --danger-dark: #f44336;
            --text-dark: #e0e0e0;
            --bg-gradient-dark: linear-gradient(135deg, #121212 0%, #1c2526 100%);
            --preview-bg-dark: linear-gradient(135deg, rgba(28, 37, 38, 0.4) 0%, rgba(18, 18, 18, 0.4) 100%);

            /* Default to Light Mode */
            --primary: var(--primary-light);
            --secondary: var(--secondary-light);
            --accent: var(--accent-light);
            --light: var(--light-light);
            --dark: var(--dark-light);
            --card-bg: var(--card-bg-light);
            --timeline-bg: var(--timeline-bg-light);
            --success: var(--success-light);
            --warning: var(--warning-light);
            --danger: var(--danger-light);
            --text: var(--text-light);
            --bg-gradient: var(--bg-gradient-light);
            --preview-bg: var(--preview-bg-light);
        }

        [data-theme="dark"] {
            --primary: var(--primary-dark);
            --secondary: var(--secondary-dark);
            --accent: var(--accent-dark);
            --light: var(--light-dark);
            --dark: var(--dark-dark);
            --card-bg: var(--card-bg-dark);
            --timeline-bg: var(--timeline-bg-dark);
            --success: var(--success-dark);
            --warning: var(--warning-dark);
            --danger: var(--danger-dark);
            --text: var(--text-dark);
            --bg-gradient: var(--bg-gradient-dark);
            --preview-bg: var(--preview-bg-dark);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .title-font {
            font-family: 'Orbitron', sans-serif;
        }

        .stunt-card {
            background: var(--card-bg);
            border-left: 4px solid var(--accent);
            transition: all 0.3s ease;
            transform: translateY(0);
        }

        .stunt-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border-left: 4px solid var(--secondary);
        }

        .timeline-item {
            background: var(--timeline-bg);
            border-left: 4px solid var(--accent);
        }

        .preview-container {
            background: var(--preview-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .btn {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .timeline-container {
            position: relative;
        }

        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 3px;
            background: var(--secondary);
            width: 0%;
            transition: width 0.1s linear;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-high {
            background: var(--danger);
            color: white;
        }

        .badge-medium {
            background: var(--warning);
            color: white;
        }

        .badge-low {
            background: var(--success);
            color: white;
        }

        .loading {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loading div {
            display: inline-block;
            position: absolute;
            left: 8px;
            width: 16px;
            background: var(--secondary);
            animation: loading 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
        }

        .loading div:nth-child(1) {
            left: 8px;
            animation-delay: -0.24s;
        }

        .loading div:nth-child(2) {
            left: 32px;
            animation-delay: -0.12s;
        }

        .loading div:nth-child(3) {
            left: 56px;
            animation-delay: 0;
        }

        @keyframes loading {
            0% {
                top: 8px;
                height: 64px;
            }

            50%,
            100% {
                top: 24px;
                height: 32px;
            }
        }

        .custom-select {
            position: relative;
            display: inline-block;
        }

        .custom-select select {
            appearance: none;
            -webkit-appearance: none;
            padding-right: 30px;
            cursor: pointer;
        }

        .custom-select:after {
            content: '\f0d7';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            background: var(--success);
            color: white;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
        }

        .character-indicators {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 10;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .indicator.active {
            background: var(--success);
        }

        .indicator.inactive {
            background: rgba(255, 255, 255, 0.3);
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        /* Safety Meter Styles */
        .safety-meter {
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, var(--success), var(--warning), var(--danger));
            position: relative;
            overflow: hidden;
        }

        .safety-meter-indicator {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform-origin: left;
            transform: scaleX(0.5);
        }

        .safety-meter-marker {
            position: absolute;
            top: -5px;
            width: 2px;
            height: 20px;
            background: white;
        }

        /* Enhanced 3D Preview Controls */
        .preview-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            gap: 5px;
        }

        .preview-control-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-control-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        /* Enhanced drag handle */
        .handle-drag {
            cursor: move;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .handle-drag:hover {
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .grid-cols-1 {
                grid-template-columns: 1fr;
            }

            .lg\:col-span-2,
            .lg\:col-span-3 {
                grid-column: span 1;
            }

            .preview-container {
                height: 300px;
            }
        }
    </style>
</head>

<body class="transition-colors duration-300">
    <div id="notification" class="notification">
        <span id="notificationText">Notification text</span>
    </div>

    <div class="container mx-auto p-4 max-w-6xl">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 mt-4">
            <div class="flex items-center">
                <h1 class="text-3xl font-bold title-font text-white mb-2 md:mb-0">
                    <i class="fas fa-film mr-2 text-secondary"></i>
                    Stunt Sequence Designer <span
                        class="text-sm bg-red-500 text-white px-2 py-1 rounded ml-2">PRO</span>
                </h1>
            </div>

            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div class="custom-select">
                    <select id="projectType"
                        class="p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white">
                        <option value="film">Film Project</option>
                        <option value="tv">TV Series</option>
                        <option value="commercial">Commercial</option>
                        <option value="music">Music Video</option>
                    </select>
                </div>
                <button id="themeToggle"
                    class="p-2 rounded bg-opacity-30 bg-gray-800 hover:bg-opacity-50 transition-all"
                    title="Toggle Theme">
                    <i id="themeIcon" class="fas fa-moon text-accent"></i>
                </button>
            </div>
        </header>

        <div class="bg-opacity-30 bg-gray-800 rounded-lg p-4 mb-6 border-l-4 border-blue-500">
            <p class="text-sm">Welcome to the Stunt Sequence Designer Pro! Drag stunts from the library to create your
                sequence, preview in 3D, and export your work. Need help? Check out our <a href="#"
                    class="text-blue-400 hover:underline">tutorials</a>.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-2">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold title-font flex items-center">
                        <i class="fas fa-book mr-2 text-accent"></i> Stunt Library
                    </h2>
                    <div class="flex space-x-2">
                        <button id="filterBtn"
                            class="px-2 py-1 rounded bg-opacity-30 bg-gray-800 hover:bg-opacity-50 transition-all">
                            <i class="fas fa-filter"></i>
                        </button>
                        <button id="sortBtn"
                            class="px-2 py-1 rounded bg-opacity-30 bg-gray-800 hover:bg-opacity-50 transition-all">
                            <i class="fas fa-sort"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-opacity-20 bg-gray-800 rounded-lg p-4 overflow-y-auto max-h-[350px] scrollbar-thin">
                    <div id="stuntLibrary" class="grid grid-cols-1 gap-3"></div>
                </div>

                <div class="mt-4 text-center">
                    <button id="addCustomStuntBtn"
                        class="btn bg-opacity-30 bg-gray-800 hover:bg-opacity-50 px-4 py-2 rounded text-sm">
                        <i class="fas fa-plus mr-1"></i> Add Custom Stunt
                    </button>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold title-font flex items-center">
                        <i class="fas fa-clock mr-2 text-accent"></i> Sequence Timeline
                    </h2>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm bg-opacity-30 bg-gray-800 px-2 py-1 rounded">
                            Total Duration: <span id="totalDuration">0</span>s
                        </span>
                        <span class="text-sm bg-opacity-30 bg-gray-800 px-2 py-1 rounded">
                            Safety: <span id="safetyRating">100%</span>
                        </span>
                    </div>
                </div>

                <div class="timeline-container bg-opacity-20 bg-gray-800 rounded-lg p-4 min-h-[350px]">
                    <div class="timeline-progress"></div>
                    <div id="timeline" class="space-y-3"></div>

                    <div id="emptyTimeline" class="flex flex-col items-center justify-center h-[300px] text-center">
                        <i class="fas fa-arrow-left text-3xl text-gray-400 mb-4"></i>
                        <p class="text-gray-400">Drag stunts from the library to add them to your sequence</p>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm">Sequence Safety Rating</span>
                        <span id="safetyText" class="text-sm font-medium">Safe</span>
                    </div>
                    <div class="safety-meter">
                        <div id="safetyMeterIndicator" class="safety-meter-indicator"></div>
                        <div class="safety-meter-marker" style="left: 33%"></div>
                        <div class="safety-meter-marker" style="left: 66%"></div>
                    </div>
                    <div class="flex justify-between text-xs mt-1">
                        <span>Low Risk</span>
                        <span>Medium Risk</span>
                        <span>High Risk</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold title-font flex items-center">
                    <i class="fas fa-cube mr-2 text-accent"></i> 3D Preview
                </h2>
                <div class="flex space-x-3">
                    <button id="cameraBtn"
                        class="px-3 py-1 text-sm rounded bg-opacity-30 bg-gray-800 hover:bg-opacity-50 transition-all">
                        <i class="fas fa-camera mr-1"></i> Camera
                    </button>
                    <button id="lightingBtn"
                        class="px-3 py-1 text-sm rounded bg-opacity-30 bg-gray-800 hover:bg-opacity-50 transition-all">
                        <i class="fas fa-lightbulb mr-1"></i> Lighting
                    </button>
                </div>
            </div>

            <div class="preview-container relative rounded-lg overflow-hidden">
                <div id="preview" class="w-full h-[500px]"></div>

                <div class="character-indicators">
                    <span class="indicator active"></span>
                    <span class="indicator active"></span>
                    <span class="indicator inactive"></span>
                </div>

                <div class="absolute bottom-4 right-4 bg-black bg-opacity-50 rounded px-2 py-1 text-sm">
                    <span id="currentTimeDisplay">00:00</span> / <span id="totalTimeDisplay">00:00</span>
                </div>

                <div class="preview-controls">
                    <div class="preview-control-btn" id="zoomInBtn" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                    </div>
                    <div class="preview-control-btn" id="zoomOutBtn" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                    </div>
                    <div class="preview-control-btn" id="rotateLeftBtn" title="Rotate Left">
                        <i class="fas fa-undo"></i>
                    </div>
                    <div class="preview-control-btn" id="rotateRightBtn" title="Rotate Right">
                        <i class="fas fa-redo"></i>
                    </div>
                    <div class="preview-control-btn" id="resetViewBtn" title="Reset View">
                        <i class="fas fa-home"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-opacity-20 bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-3 title-font">Playback</h3>
                <div class="flex items-center space-x-2">
                    <button id="playButton" class="btn btn-primary px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-play mr-2"></i> Play
                    </button>
                    <button id="pauseButton" class="btn btn-danger px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-pause mr-2"></i> Pause
                    </button>
                    <button id="resetButton"
                        class="btn bg-opacity-30 bg-gray-800 hover:bg-opacity-50 px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-undo mr-2"></i> Reset
                    </button>
                </div>
                <div class="mt-3">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="slowMotionCheckbox" class="form-checkbox rounded text-accent">
                        <span class="ml-2"><i class="fas fa-hourglass-half mr-1"></i> Slow Motion</span>
                    </label>
                </div>
            </div>

            <div class="bg-opacity-20 bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-3 title-font">Effects</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button class="btn bg-opacity-30 bg-gray-800 hover:bg-opacity-50 px-2 py-2 rounded-md text-sm">
                        <i class="fas fa-fire mr-1"></i> Explosion
                    </button>
                    <button class="btn bg-opacity-30 bg-gray-800 hover:bg-opacity-50 px-2 py-2 rounded-md text-sm">
                        <i class="fas fa-wind mr-1"></i> Wind
                    </button>
                    <button class="btn bg-opacity-30 bg-gray-800 hover:bg-opacity-50 px-2 py-2 rounded-md text-sm">
                        <i class="fas fa-tint mr-1"></i> Rain
                    </button>
                    <button class="btn bg-opacity-30 bg-gray-800 hover:bg-opacity-50 px-2 py-2 rounded-md text-sm">
                        <i class="fas fa-smog mr-1"></i> Smoke
                    </button>
                </div>
            </div>

            <div class="bg-opacity-20 bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-3 title-font">Project</h3>
                <div class="flex items-center space-x-2">
                    <button id="saveButton" class="btn btn-success px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-save mr-2"></i> Save
                    </button>
                    <button id="exportButton" class="btn btn-warning px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-file-export mr-2"></i> Export
                    </button>
                    <div class="relative">
                        <button id="shareButton"
                            class="btn bg-opacity-30 bg-gray-800 hover:bg-opacity-50 px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-share-alt mr-2"></i> Share
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-sm text-gray-400 py-4">
            <p>Stunt Sequence Designer Pro v2.0 | <a href="#" class="hover:text-white">Documentation</a> | <a href="#"
                    class="hover:text-white">Support</a></p>
        </footer>
    </div>

    <script>
        // Constants
        const STUNT_TYPES = {
            FILM: 'film',
            TV: 'tv',
            COMMERCIAL: 'commercial',
            MUSIC: 'music'
        };

        // Stunt Library Data
        const stuntLibrary = [
            {
                id: 1,
                name: "High Fall",
                duration: 5,
                description: "Actor falls from a great height onto an airbag or safety mat",
                difficulty: "High",
                category: "Heights",
                icon: "fa-person-falling",
                model: "fall",
                safetyImpact: 30,
                actors: 1
            },
            {
                id: 2,
                name: "Car Chase",
                duration: 12,
                description: "High-speed pursuit through city streets with precision driving",
                difficulty: "Medium",
                category: "Vehicles",
                icon: "fa-car-side",
                model: "car",
                safetyImpact: 20,
                actors: 2
            },
            {
                id: 3,
                name: "Controlled Explosion",
                duration: 3,
                description: "Pyrotechnic effect with actor in proximity, creating dramatic blast",
                difficulty: "High",
                category: "Pyrotechnics",
                icon: "fa-burst",
                model: "explosion",
                safetyImpact: 35,
                actors: 1
            },
            {
                id: 4,
                name: "Fight Sequence",
                duration: 8,
                description: "Choreographed hand-to-hand combat between multiple actors",
                difficulty: "Medium",
                category: "Combat",
                icon: "fa-hand-fist",
                model: "fight",
                safetyImpact: 15,
                actors: 3
            },
            {
                id: 5,
                name: "Wire Work",
                duration: 6,
                description: "Actor suspended by wires for aerial movements and stunts",
                difficulty: "High",
                category: "Aerial",
                icon: "fa-person-walking-arrow-right",
                model: "wire",
                safetyImpact: 25,
                actors: 1
            },
            {
                id: 6,
                name: "Motorcycle Jump",
                duration: 4,
                description: "Stunt rider jumps motorcycle over obstacle or gap",
                difficulty: "High",
                category: "Vehicles",
                icon: "fa-motorcycle",
                model: "motorcycle",
                safetyImpact: 40,
                actors: 1
            },
            {
                id: 7,
                name: "Fire Stunt",
                duration: 5,
                description: "Performer partially or fully engulfed in controlled flames",
                difficulty: "High",
                category: "Pyrotechnics",
                icon: "fa-fire",
                model: "fire",
                safetyImpact: 45,
                actors: 1
            },
            {
                id: 8,
                name: "Glass Break",
                duration: 2,
                description: "Actor crashes through breakaway glass panel",
                difficulty: "Medium",
                category: "Practical Effects",
                icon: "fa-glass-water-droplet",
                model: "glass",
                safetyImpact: 10,
                actors: 1
            }
        ];

        // App State
        const state = {
            timeline: [],
            isPlaying: false,
            isSlowMotion: false,
            currentTime: 0,
            animationSpeed: 1,
            totalDuration: 0,
            currentStuntIndex: 0,
            activeEffects: {
                explosion: false,
                wind: false,
                rain: false,
                smoke: false
            },
            cameraDistance: 5,
            cameraAngle: 0,
            theme: 'light',
            filter: { category: 'all', difficulty: 'all' },
            sort: { field: 'name', order: 'asc' },
            cameraType: 'perspective',
            lightingIntensity: 0.5
        };

        // Scene Elements
        let scene, camera, renderer, currentModel;
        let ambientLight, directionalLight;
        let explosionParticles = [];
        let rainParticles = [];
        let smokeParticles = [];
        let windForce = new THREE.Vector3();

        // DOM Elements
        const elements = {
            stuntLibrary: document.getElementById('stuntLibrary'),
            timeline: document.getElementById('timeline'),
            preview: document.getElementById('preview'),
            playButton: document.getElementById('playButton'),
            pauseButton: document.getElementById('pauseButton'),
            resetButton: document.getElementById('resetButton'),
            saveButton: document.getElementById('saveButton'),
            exportButton: document.getElementById('exportButton'),
            shareButton: document.getElementById('shareButton'),
            slowMotionCheckbox: document.getElementById('slowMotionCheckbox'),
            emptyTimeline: document.getElementById('emptyTimeline'),
            totalDuration: document.getElementById('totalDuration'),
            currentTimeDisplay: document.getElementById('currentTimeDisplay'),
            totalTimeDisplay: document.getElementById('totalTimeDisplay'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notificationText'),
            timelineProgress: document.querySelector('.timeline-progress'),
            themeToggle: document.getElementById('themeToggle'),
            themeIcon: document.getElementById('themeIcon'),
            safetyRating: document.getElementById('safetyRating'),
            safetyMeterIndicator: document.getElementById('safetyMeterIndicator'),
            safetyText: document.getElementById('safetyText'),
            projectType: document.getElementById('projectType'),
            filterBtn: document.getElementById('filterBtn'),
            sortBtn: document.getElementById('sortBtn'),
            addCustomStuntBtn: document.getElementById('addCustomStuntBtn'),
            cameraBtn: document.getElementById('cameraBtn'),
            lightingBtn: document.getElementById('lightingBtn'),
            characterIndicators: document.querySelector('.character-indicators')
        };

        // Initialize the application
        function init() {
            renderStuntLibrary();
            initializeScene();
            loadSavedTimeline();
            setupEventListeners();
            updateTimelineStatus();
            updateTotalDuration();
            initializeTheme();
            updateSafetyRating();
            updateCharacterIndicators();
        }

        // 3D Scene Initialization
        function initializeScene() {
            scene = new THREE.Scene();
            updateCamera();
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(elements.preview.clientWidth, elements.preview.clientHeight);
            elements.preview.appendChild(renderer.domElement);

            setupLighting();
            createFloor();
            createGridHelper();
            loadPlaceholderModel();
            setupCameraControls();
            animate();
        }

        function updateCamera() {
            const aspect = elements.preview.clientWidth / elements.preview.clientHeight;
            if (state.cameraType === 'perspective') {
                camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
            } else {
                camera = new THREE.OrthographicCamera(-aspect * 5, aspect * 5, 5, -5, 0.1, 1000);
            }
            updateCameraPosition();
        }

        function setupLighting() {
            ambientLight = new THREE.AmbientLight(0x404040, state.lightingIntensity);
            scene.add(ambientLight);
            directionalLight = new THREE.DirectionalLight(0xffffff, state.lightingIntensity);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
        }

        function updateLighting() {
            ambientLight.intensity = state.lightingIntensity;
            directionalLight.intensity = state.lightingIntensity;
        }

        function createFloor() {
            const floorGeometry = new THREE.PlaneGeometry(100, 100);
            const floorMaterial = new THREE.MeshStandardMaterial({
                color: 0x2c3e50,
                side: THREE.DoubleSide,
                metalness: 0.1,
                roughness: 0.7
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = Math.PI / 2;
            floor.position.y = -1;
            scene.add(floor);
        }

        function createGridHelper() {
            const gridHelper = new THREE.GridHelper(100, 100, 0x555555, 0x333333);
            scene.add(gridHelper);
        }

        function updateCameraPosition() {
            camera.position.x = Math.sin(state.cameraAngle) * state.cameraDistance;
            camera.position.z = Math.cos(state.cameraAngle) * state.cameraDistance;
            camera.position.y = 2;
            camera.lookAt(0, 0, 0);
        }

        // Model Loading
        function loadPlaceholderModel() {
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshStandardMaterial({
                color: 0xe74c3c,
                metalness: 0.3,
                roughness: 0.4
            });
            currentModel = new THREE.Mesh(geometry, material);
            scene.add(currentModel);
        }

        function loadStuntModel(modelType) {
            if (currentModel) {
                scene.remove(currentModel);
            }
            switch (modelType) {
                case 'car':
                    createCarModel();
                    break;
                case 'explosion':
                    createExplosionModel();
                    break;
                default:
                    loadPlaceholderModel();
            }
        }

        function createCarModel() {
            const group = new THREE.Group();
            const bodyGeometry = new THREE.BoxGeometry(2, 1, 0.5);
            const bodyMaterial = new THREE.MeshStandardMaterial({
                color: 0x3498db,
                metalness: 0.7,
                roughness: 0.2
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            group.add(body);

            const wheelGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16);
            const wheelMaterial = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const positions = [
                { x: 0.7, y: -0.5, z: 0.3 },
                { x: -0.7, y: -0.5, z: 0.3 },
                { x: 0.7, y: -0.5, z: -0.3 },
                { x: -0.7, y: -0.5, z: -0.3 }
            ];
            positions.forEach(pos => {
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheel.rotation.z = Math.PI / 2;
                wheel.position.set(pos.x, pos.y, pos.z);
                group.add(wheel);
            });

            currentModel = group;
            scene.add(currentModel);
        }

        function createExplosionModel() {
            const group = new THREE.Group();
            const coreGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            const coreMaterial = new THREE.MeshStandardMaterial({
                color: 0xff6600,
                emissive: 0xff6600,
                emissiveIntensity: 0.5
            });
            const core = new THREE.Mesh(coreGeometry, coreMaterial);
            group.add(core);

            for (let i = 0; i < 8; i++) {
                const flameGeometry = new THREE.ConeGeometry(0.3, 1, 4);
                const flameMaterial = new THREE.MeshStandardMaterial({
                    color: 0xff9900,
                    transparent: true,
                    opacity: 0.8
                });
                const flame = new THREE.Mesh(flameGeometry, flameMaterial);
                flame.rotation.x = Math.PI / 2;
                flame.position.y = 0.5;
                flame.rotation.z = (i / 8) * Math.PI * 2;
                group.add(flame);
            }

            currentModel = group;
            scene.add(currentModel);
        }

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            if (state.isPlaying && state.timeline.length > 0) {
                updateTimelineAnimation();
            }
            updateEffects();
            renderer.render(scene, camera);
        }

        function updateTimelineAnimation() {
            state.currentTime += 0.016 * state.animationSpeed;
            const currentStunt = state.timeline[state.currentStuntIndex];

            if (state.currentTime >= currentStunt.duration) {
                moveToNextStunt();
            }

            const progress = (state.currentTime / currentStunt.duration) * 100;
            elements.timelineProgress.style.width = `${progress}%`;

            if (currentModel) {
                animateCurrentStunt();
            }

            updateTimeDisplay();
            updateCharacterIndicators();
        }

        function moveToNextStunt() {
            state.currentTime = 0;
            state.currentStuntIndex = (state.currentStuntIndex + 1) % state.timeline.length;
            loadStuntModel(state.timeline[state.currentStuntIndex].model);
            updateCharacterIndicators();
        }

        function animateCurrentStunt() {
            const stunt = state.timeline[state.currentStuntIndex];
            switch (stunt.model) {
                case 'car':
                    currentModel.rotation.y += 0.02 * state.animationSpeed;
                    currentModel.position.x = Math.sin(state.currentTime * 0.5) * 2;
                    break;
                case 'explosion':
                    currentModel.rotation.y += 0.01 * state.animationSpeed;
                    currentModel.children.forEach(child => {
                        child.scale.x = 1 + Math.sin(state.currentTime * 5) * 0.1;
                        child.scale.y = 1 + Math.sin(state.currentTime * 5) * 0.1;
                    });
                    break;
            }
        }

        // Effect System
        function createEffect(type) {
            switch (type) {
                case 'explosion':
                    createExplosionEffect();
                    break;
                case 'rain':
                    createRainEffect();
                    break;
                case 'smoke':
                    createSmokeEffect();
                    break;
                case 'wind':
                    createWindEffect();
                    break;
            }
        }

        function clearEffect(type) {
            switch (type) {
                case 'explosion':
                    clearParticles(explosionParticles);
                    break;
                case 'rain':
                    clearParticles(rainParticles);
                    break;
                case 'smoke':
                    clearParticles(smokeParticles);
                    break;
                case 'wind':
                    windForce.set(0, 0, 0);
                    break;
            }
        }

        function clearParticles(particlesArray) {
            particlesArray.forEach(particle => scene.remove(particle));
            particlesArray.length = 0;
        }

        function createExplosionEffect() {
            for (let i = 0; i < 100; i++) {
                const size = 0.1 + Math.random() * 0.3;
                const geometry = new THREE.SphereGeometry(size, 16, 16);
                const material = new THREE.MeshBasicMaterial({
                    color: new THREE.Color(`hsl(${20 + Math.random() * 20}, 100%, 50%)`),
                    transparent: true,
                    opacity: 0.8
                });
                const particle = new THREE.Mesh(geometry, material);
                particle.position.set(0, 0, 0);
                particle.userData = {
                    velocity: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.2,
                        Math.random() * 0.2,
                        (Math.random() - 0.5) * 0.2
                    ),
                    life: 100 + Math.random() * 50
                };
                scene.add(particle);
                explosionParticles.push(particle);
            }
        }

        function createRainEffect() {
            for (let i = 0; i < 200; i++) {
                const geometry = new THREE.BufferGeometry();
                const vertices = new Float32Array([0, 0, 0, 0, -0.5, 0]);
                geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
                const material = new THREE.LineBasicMaterial({ color: 0xaaaaaa });
                const rainDrop = new THREE.Line(geometry, material);
                rainDrop.position.set(
                    (Math.random() - 0.5) * 20,
                    Math.random() * 10 + 10,
                    (Math.random() - 0.5) * 20
                );
                rainDrop.userData = {
                    speed: 0.5 + Math.random() * 0.5,
                    originalY: rainDrop.position.y
                };
                scene.add(rainDrop);
                rainParticles.push(rainDrop);
            }
        }

        function createSmokeEffect() {
            for (let i = 0; i < 50; i++) {
                const size = 0.2 + Math.random() * 0.3;
                const geometry = new THREE.SphereGeometry(size, 16, 16);
                const material = new THREE.MeshBasicMaterial({
                    color: 0x888888,
                    transparent: true,
                    opacity: 0.4
                });
                const smokePuff = new THREE.Mesh(geometry, material);
                smokePuff.position.set(
                    (Math.random() - 0.5) * 5,
                    0.5,
                    (Math.random() - 0.5) * 5
                );
                smokePuff.userData = {
                    velocity: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.01,
                        0.02 + Math.random() * 0.03,
                        (Math.random() - 0.5) * 0.01
                    ),
                    life: 200 + Math.random() * 100,
                    size: size
                };
                scene.add(smokePuff);
                smokeParticles.push(smokePuff);
            }
        }

        function createWindEffect() {
            windForce.set(
                (Math.random() - 0.5) * 0.05,
                0,
                (Math.random() - 0.5) * 0.05
            );
        }

        function updateEffects() {
            updateParticles(explosionParticles, updateExplosionParticle);
            updateParticles(rainParticles, updateRainParticle);
            updateParticles(smokeParticles, updateSmokeParticle);
        }

        function updateParticles(particlesArray, updateFunction) {
            for (let i = particlesArray.length - 1; i >= 0; i--) {
                const particle = particlesArray[i];
                if (updateFunction(particle) === false) {
                    scene.remove(particle);
                    particlesArray.splice(i, 1);
                }
            }
        }

        function updateExplosionParticle(particle) {
            particle.userData.life--;
            if (particle.userData.life <= 0) return false;
            particle.position.add(particle.userData.velocity);
            particle.material.opacity = particle.userData.life / 150;
            return true;
        }

        function updateRainParticle(particle) {
            particle.position.y -= particle.userData.speed;
            if (particle.position.y < -5) {
                particle.position.y = particle.userData.originalY;
                particle.position.x = (Math.random() - 0.5) * 20;
                particle.position.z = (Math.random() - 0.5) * 20;
            }
            if (state.activeEffects.wind) {
                particle.position.x += windForce.x;
                particle.position.z += windForce.z;
            }
            return true;
        }

        function updateSmokeParticle(particle) {
            particle.userData.life--;
            if (particle.userData.life <= 0) return false;
            particle.position.add(particle.userData.velocity);
            particle.material.opacity = (particle.userData.life / 300) * 0.4;
            particle.scale.setScalar(particle.userData.size * (1 + (300 - particle.userData.life) / 300));
            if (state.activeEffects.wind) {
                particle.position.x += windForce.x * 2;
                particle.position.z += windForce.z * 2;
            }
            return true;
        }

        // UI Rendering
        function renderStuntLibrary() {
            elements.stuntLibrary.innerHTML = '';
            const filteredStunts = filterStunts(stuntLibrary);
            const sortedStunts = sortStunts(filteredStunts);
            sortedStunts.forEach(stunt => {
                const stuntElement = document.createElement('div');
                stuntElement.className = 'stunt-card p-3 rounded-lg cursor-pointer transition-all';
                stuntElement.draggable = true;
                stuntElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-full bg-opacity-30 bg-accent flex items-center justify-center mr-3">
                                <i class="fas ${stunt.icon} text-accent"></i>
                            </div>
                            <div>
                                <h3 class="font-bold">${stunt.name}</h3>
                                <div class="flex items-center text-xs text-gray-300 mt-1">
                                    <span><i class="fas fa-clock mr-1"></i> ${stunt.duration}s</span>
                                    <span class="mx-2">•</span>
                                    <span><i class="fas fa-layer-group mr-1"></i> ${stunt.category}</span>
                                </div>
                            </div>
                        </div>
                        <span class="badge ${getDifficultyBadgeClass(stunt.difficulty)}">
                            ${stunt.difficulty}
                        </span>
                    </div>
                    <p class="text-sm mt-2 text-gray-300">${stunt.description}</p>
                    <div class="mt-2 text-xs">
                        <button class="px-2 py-1 bg-accent bg-opacity-20 text-accent rounded hover:bg-opacity-30 transition-all">
                            <i class="fas fa-plus mr-1"></i> Add to Sequence
                        </button>
                    </div>
                `;
                stuntElement.addEventListener('click', () => addStunt(stunt));
                stuntElement.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('stuntId', stunt.id);
                    stuntElement.classList.add('opacity-50');
                });
                stuntElement.addEventListener('dragend', () => {
                    stuntElement.classList.remove('opacity-50');
                });
                elements.stuntLibrary.appendChild(stuntElement);
            });
        }

        function filterStunts(stunts) {
            return stunts.filter(stunt => {
                const matchesCategory = state.filter.category === 'all' || stunt.category === state.filter.category;
                const matchesDifficulty = state.filter.difficulty === 'all' || stunt.difficulty === state.filter.difficulty;
                return matchesCategory && matchesDifficulty;
            });
        }

        function sortStunts(stunts) {
            return [...stunts].sort((a, b) => {
                const field = state.sort.field;
                const order = state.sort.order === 'asc' ? 1 : -1;
                if (field === 'name') {
                    return a.name.localeCompare(b.name) * order;
                } else if (field === 'duration') {
                    return (a.duration - b.duration) * order;
                } else if (field === 'difficulty') {
                    const difficultyOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                    return (difficultyOrder[a.difficulty] - difficultyOrder[b.difficulty]) * order;
                }
                return 0;
            });
        }

        function getDifficultyBadgeClass(difficulty) {
            switch (difficulty) {
                case 'High': return 'badge-high';
                case 'Medium': return 'badge-medium';
                default: return 'badge-low';
            }
        }

        function renderTimeline() {
            elements.timeline.innerHTML = '';
            state.timeline.forEach((stunt, index) => {
                const stuntElement = document.createElement('div');
                stuntElement.className = 'timeline-item p-3 rounded-lg flex justify-between items-center relative transition-all';
                stuntElement.dataset.index = index;
                stuntElement.draggable = true;
                stuntElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-opacity-30 bg-accent flex items-center justify-center mr-3">
                            <i class="fas ${stunt.icon} text-accent"></i>
                        </div>
                        <div>
                            <h3 class="font-bold">${stunt.name}</h3>
                            <div class="flex items-center text-xs text-gray-300 mt-1">
                                <span><i class="fas fa-clock mr-1"></i> ${stunt.duration}s</span>
                                <span class="mx-2">•</span>
                                <span class="badge ${getDifficultyBadgeClass(stunt.difficulty)} text-xs">
                                    ${stunt.difficulty}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="handle-drag p-1 rounded hover:bg-gray-700 cursor-move">
                            <i class="fas fa-grip-lines"></i>
                        </button>
                        <button class="p-1 rounded hover:bg-gray-700" onclick="app.moveStuntUp(${index})">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="p-1 rounded hover:bg-gray-700" onclick="app.moveStuntDown(${index})">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="p-1 rounded hover:bg-red-900 text-red-400" onclick="app.removeStunt(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                setupTimelineItemDragEvents(stuntElement, index);
                elements.timeline.appendChild(stuntElement);
            });
            updateTimelineStatus();
            updateTotalDuration();
            updateSafetyRating();
        }

        function setupTimelineItemDragEvents(element, index) {
            element.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('timelineIndex', index);
                element.classList.add('opacity-50');
            });
            element.addEventListener('dragend', () => {
                element.classList.remove('opacity-50');
            });
            element.addEventListener('dragover', (e) => e.preventDefault());
            element.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedIndex = parseInt(e.dataTransfer.getData('timelineIndex'));
                if (!isNaN(draggedIndex) && draggedIndex !== index) {
                    reorderTimeline(draggedIndex, index);
                }
            });
        }

        // Event Listeners
        function setupEventListeners() {
            elements.timeline.addEventListener('dragover', (e) => e.preventDefault());
            elements.timeline.addEventListener('drop', (e) => {
                e.preventDefault();
                const stuntId = e.dataTransfer.getData('stuntId');
                if (stuntId) {
                    const stunt = stuntLibrary.find(s => s.id === parseInt(stuntId));
                    if (stunt) addStunt(stunt);
                }
            });

            elements.playButton.addEventListener('click', playAnimation);
            elements.pauseButton.addEventListener('click', pauseAnimation);
            elements.resetButton.addEventListener('click', resetAnimation);
            elements.slowMotionCheckbox.addEventListener('change', toggleSlowMotion);
            elements.saveButton.addEventListener('click', saveTimeline);
            elements.exportButton.addEventListener('click', exportTimeline);
            elements.shareButton.addEventListener('click', shareTimeline);
            elements.themeToggle.addEventListener('click', toggleTheme);
            elements.projectType.addEventListener('change', () => {
                showNotification(`Project type changed to ${elements.projectType.value}`, 'success');
            });

            elements.filterBtn.addEventListener('click', showFilterModal);
            elements.sortBtn.addEventListener('click', showSortModal);
            elements.addCustomStuntBtn.addEventListener('click', showCustomStuntModal);
            elements.cameraBtn.addEventListener('click', toggleCameraType);
            elements.lightingBtn.addEventListener('click', adjustLighting);

            document.getElementById('zoomInBtn').addEventListener('click', () => {
                state.cameraDistance = Math.max(2, state.cameraDistance - 0.5);
                updateCameraPosition();
            });
            document.getElementById('zoomOutBtn').addEventListener('click', () => {
                state.cameraDistance = Math.min(10, state.cameraDistance + 0.5);
                updateCameraPosition();
            });
            document.getElementById('rotateLeftBtn').addEventListener('click', () => {
                state.cameraAngle += 0.2;
                updateCameraPosition();
            });
            document.getElementById('rotateRightBtn').addEventListener('click', () => {
                state.cameraAngle -= 0.2;
                updateCameraPosition();
            });
            document.getElementById('resetViewBtn').addEventListener('click', () => {
                state.cameraDistance = 5;
                state.cameraAngle = 0;
                updateCameraPosition();
            });

            document.querySelectorAll('.grid-cols-2 button').forEach(button => {
                button.addEventListener('click', () => {
                    const effect = button.querySelector('i').className.match(/fa-(\w+)/)[1];
                    toggleEffect(effect, button);
                });
            });

            window.addEventListener('resize', () => {
                camera.aspect = elements.preview.clientWidth / elements.preview.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(elements.preview.clientWidth, elements.preview.clientHeight);
            });
        }

        // Camera Controls
        function setupCameraControls() {
            let isDragging = false;
            let previousTouchDistance = 0;
            let previousMousePosition = { x: 0, y: 0 };

            elements.preview.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            elements.preview.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    isDragging = true;
                    previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                } else if (e.touches.length === 2) {
                    previousTouchDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                }
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
            });

            window.addEventListener('touchend', () => {
                isDragging = false;
                previousTouchDistance = 0;
            });

            elements.preview.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaMove = {
                    x: e.clientX - previousMousePosition.x,
                    y: e.clientY - previousMousePosition.y
                };
                state.cameraAngle += deltaMove.x * 0.01;
                updateCameraPosition();
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            elements.preview.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 1 && isDragging) {
                    const deltaMove = {
                        x: e.touches[0].clientX - previousMousePosition.x,
                        y: e.touches[0].clientY - previousMousePosition.y
                    };
                    state.cameraAngle += deltaMove.x * 0.01;
                    updateCameraPosition();
                    previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                } else if (e.touches.length === 2) {
                    const currentTouchDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const delta = currentTouchDistance - previousTouchDistance;
                    state.cameraDistance = Math.min(10, Math.max(2, state.cameraDistance - delta * 0.01));
                    updateCameraPosition();
                    previousTouchDistance = currentTouchDistance;
                }
            }, { passive: false });

            elements.preview.addEventListener('wheel', (e) => {
                state.cameraDistance = Math.min(10, Math.max(2, state.cameraDistance + e.deltaY * -0.01));
                updateCameraPosition();
                e.preventDefault();
            }, { passive: false });
        }

        // Timeline Management
        function addStunt(stunt) {
            state.timeline.push({ ...stunt });
            renderTimeline();
            showNotification(`${stunt.name} added to sequence`, 'success');
        }

        function removeStunt(index) {
            const removedStunt = state.timeline.splice(index, 1)[0];
            renderTimeline();
            showNotification(`${removedStunt.name} removed from sequence`, 'success');
        }

        function moveStuntUp(index) {
            if (index > 0) {
                [state.timeline[index], state.timeline[index - 1]] = [state.timeline[index - 1], state.timeline[index]];
                renderTimeline();
                showNotification('Stunt moved up', 'success');
            }
        }

        function moveStuntDown(index) {
            if (index < state.timeline.length - 1) {
                [state.timeline[index], state.timeline[index + 1]] = [state.timeline[index + 1], state.timeline[index]];
                renderTimeline();
                showNotification('Stunt moved down', 'success');
            }
        }

        function reorderTimeline(fromIndex, toIndex) {
            const [movedStunt] = state.timeline.splice(fromIndex, 1);
            state.timeline.splice(toIndex, 0, movedStunt);
            renderTimeline();
            showNotification('Stunt reordered successfully', 'success');
        }

        // Animation Controls
        function playAnimation() {
            if (state.timeline.length === 0) {
                showNotification('Add stunts to the timeline first', 'warning');
                return;
            }
            state.isPlaying = true;
            elements.playButton.classList.add('hidden');
            elements.pauseButton.classList.remove('hidden');
            showNotification('Playing sequence', 'success');
        }

        function pauseAnimation() {
            state.isPlaying = false;
            elements.playButton.classList.remove('hidden');
            elements.pauseButton.classList.add('hidden');
            showNotification('Sequence paused', 'warning');
        }

        function resetAnimation() {
            state.isPlaying = false;
            state.currentTime = 0;
            state.currentStuntIndex = 0;
            elements.timelineProgress.style.width = '0%';
            elements.playButton.classList.remove('hidden');
            elements.pauseButton.classList.add('hidden');
            updateTimeDisplay();
            loadStuntModel(state.timeline[0]?.model || null);
            updateCharacterIndicators();
            showNotification('Sequence reset', 'success');
        }

        function toggleSlowMotion() {
            state.isSlowMotion = elements.slowMotionCheckbox.checked;
            state.animationSpeed = state.isSlowMotion ? 0.5 : 1;
            showNotification(state.isSlowMotion ? 'Slow motion enabled' : 'Slow motion disabled', 'success');
        }

        // Project Management
        function saveTimeline() {
            try {
                localStorage.setItem('stuntSequence', JSON.stringify(state.timeline));
                showNotification('Sequence saved successfully', 'success');
            } catch (error) {
                showNotification('Error saving sequence', 'error');
            }
        }

        function loadSavedTimeline() {
            try {
                const saved = localStorage.getItem('stuntSequence');
                if (saved) {
                    state.timeline = JSON.parse(saved);
                    renderTimeline();
                    showNotification('Loaded saved sequence', 'success');
                }
            } catch (error) {
                showNotification('Error loading saved sequence', 'error');
            }
        }

        function exportTimeline() {
            const exportData = {
                projectType: elements.projectType.value,
                timeline: state.timeline,
                totalDuration: state.totalDuration,
                safetyRating: calculateSafetyRating()
            };
            const textSummary = `
        Stunt Sequence Export
        ====================
        Project Type: ${exportData.projectType}
        Total Duration: ${exportData.totalDuration}s
        Safety Rating: ${exportData.safetyRating}%
        ====================
        Stunts:
        ${exportData.timeline.map((stunt, index) => `${index + 1}. ${stunt.name} (${stunt.duration}s, ${stunt.difficulty}) - ${stunt.description}`).join('\n')}
        ====================
        Generated by Stunt Sequence Designer Pro
            `.trim();
            const blob = new Blob([textSummary], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stunt_sequence.txt';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Sequence exported successfully', 'success');
        }

        function shareTimeline() {
            const shareText = `Check out my stunt sequence for ${elements.projectType.value}! ${state.totalDuration}s of action with ${state.timeline.length} stunts!`;
            if (navigator.share) {
                navigator.share({
                    title: 'Stunt Sequence',
                    text: shareText,
                    url: window.location.href
                }).then(() => showNotification('Sequence shared successfully', 'success'))
                    .catch(() => showNotification('Error sharing sequence', 'error'));
            } else {
                navigator.clipboard.writeText(shareText)
                    .then(() => showNotification('Sequence link copied to clipboard', 'success'))
                    .catch(() => showNotification('Error copying to clipboard', 'error'));
            }
        }

        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            state.theme = savedTheme;
            document.body.dataset.theme = savedTheme;
            elements.themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun text-accent' : 'fas fa-moon text-accent';
            elements.pauseButton.classList.add('hidden'); // Hide pause button initially
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.body.dataset.theme = state.theme;
            localStorage.setItem('theme', state.theme);
            elements.themeIcon.className = state.theme === 'dark' ? 'fas fa-sun text-accent' : 'fas fa-moon text-accent';
            showNotification(`Switched to ${state.theme} mode`, 'success');
        }

        // Effect Controls
        function toggleEffect(effect, button) {
            state.activeEffects[effect] = !state.activeEffects[effect];
            if (state.activeEffects[effect]) {
                createEffect(effect);
                button.classList.add('bg-accent', 'text-white');
                showNotification(`${effect.charAt(0).toUpperCase() + effect.slice(1)} effect enabled`, 'success');
            } else {
                clearEffect(effect);
                button.classList.remove('bg-accent', 'text-white');
                showNotification(`${effect.charAt(0).toUpperCase() + effect.slice(1)} effect disabled`, 'success');
            }
        }

        // Filter and Sort Modals
        function showFilterModal() {
            const categories = ['all', ...new Set(stuntLibrary.map(s => s.category))];
            const difficulties = ['all', 'High', 'Medium', 'Low'];
            const modal = createModal(`
                <h2 class="text-lg font-bold mb-4">Filter Stunts</h2>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Category</label>
                    <select id="filterCategory" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white">
                        ${categories.map(cat => `<option value="${cat}" ${state.filter.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Difficulty</label>
                    <select id="filterDifficulty" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white">
                        ${difficulties.map(diff => `<option value="${diff}" ${state.filter.difficulty === diff ? 'selected' : ''}>${diff}</option>`).join('')}
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="filterApply" class="btn btn-primary px-4 py-2">Apply</button>
                    <button id="filterCancel" class="btn bg-opacity-30 bg-gray-800 px-4 py-2">Cancel</button>
                </div>
            `);
            document.getElementById('filterApply').addEventListener('click', () => {
                state.filter.category = document.getElementById('filterCategory').value;
                state.filter.difficulty = document.getElementById('filterDifficulty').value;
                renderStuntLibrary();
                modal.remove();
                showNotification('Filters applied', 'success');
            });
            document.getElementById('filterCancel').addEventListener('click', () => modal.remove());
        }

        function showSortModal() {
            const fields = ['name', 'duration', 'difficulty'];
            const orders = ['asc', 'desc'];
            const modal = createModal(`
                <h2 class="text-lg font-bold mb-4">Sort Stunts</h2>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Sort By</label>
                    <select id="sortField" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white">
                        ${fields.map(field => `<option value="${field}" ${state.sort.field === field ? 'selected' : ''}>${field.charAt(0).toUpperCase() + field.slice(1)}</option>`).join('')}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Order</label>
                    <select id="sortOrder" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white">
                        ${orders.map(order => `<option value="${order}" ${state.sort.order === order ? 'selected' : ''}>${order === 'asc' ? 'Ascending' : 'Descending'}</option>`).join('')}
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="sortApply" class="btn btn-primary px-4 py-2">Apply</button>
                    <button id="sortCancel" class="btn bg-opacity-30 bg-gray-800 px-4 py-2">Cancel</button>
                </div>
            `);
            document.getElementById('sortApply').addEventListener('click', () => {
                state.sort.field = document.getElementById('sortField').value;
                state.sort.order = document.getElementById('sortOrder').value;
                renderStuntLibrary();
                modal.remove();
                showNotification('Sort applied', 'success');
            });
            document.getElementById('sortCancel').addEventListener('click', () => modal.remove());
        }

        // Custom Stunt Modal
        function showCustomStuntModal() {
            const modal = createModal(`
                <h2 class="text-lg font-bold mb-4">Add Custom Stunt</h2>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Name</label>
                    <input id="customName" type="text" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Duration (seconds)</label>
                    <input id="customDuration" type="number" min="1" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Description</label>
                    <textarea id="customDescription" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white" required></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Difficulty</label>
                    <select id="customDifficulty" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Category</label>
                    <input id="customCategory" type="text" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm mb-1">Number of Actors</label>
                    <input id="customActors" type="number" min="1" class="w-full p-2 rounded bg-opacity-30 bg-gray-800 border border-gray-700 text-white" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="customApply" class="btn btn-primary px-4 py-2">Add</button>
                    <button id="customCancel" class="btn bg-opacity-30 bg-gray-800 px-4 py-2">Cancel</button>
                </div>
            `);
            document.getElementById('customApply').addEventListener('click', () => {
                const name = document.getElementById('customName').value.trim();
                const duration = parseInt(document.getElementById('customDuration').value);
                const description = document.getElementById('customDescription').value.trim();
                const difficulty = document.getElementById('customDifficulty').value;
                const category = document.getElementById('customCategory').value.trim();
                const actors = parseInt(document.getElementById('customActors').value);

                if (!name || !duration || !description || !category || !actors) {
                    showNotification('Please fill all fields', 'error');
                    return;
                }

                const customStunt = {
                    id: stuntLibrary.length + 1,
                    name,
                    duration,
                    description,
                    difficulty,
                    category,
                    icon: 'fa-star', // Default icon for custom stunts
                    model: 'placeholder',
                    safetyImpact: difficulty === 'High' ? 30 : difficulty === 'Medium' ? 20 : 10,
                    actors
                };
                stuntLibrary.push(customStunt);
                addStunt(customStunt);
                renderStuntLibrary();
                modal.remove();
                showNotification('Custom stunt added', 'success');
            });
            document.getElementById('customCancel').addEventListener('click', () => modal.remove());
        }

        // Camera and Lighting Controls
        function toggleCameraType() {
            state.cameraType = state.cameraType === 'perspective' ? 'orthographic' : 'perspective';
            updateCamera();
            showNotification(`Camera switched to ${state.cameraType}`, 'success');
        }

        function adjustLighting() {
            state.lightingIntensity = state.lightingIntensity === 0.5 ? 1.0 : state.lightingIntensity === 1.0 ? 0.2 : 0.5;
            updateLighting();
            showNotification(`Lighting intensity set to ${state.lightingIntensity}`, 'success');
        }

        // Utility Functions
        function updateTimelineStatus() {
            elements.emptyTimeline.style.display = state.timeline.length === 0 ? 'flex' : 'none';
            elements.timeline.style.display = state.timeline.length > 0 ? 'block' : 'none';
        }

        function updateTotalDuration() {
            state.totalDuration = state.timeline.reduce((sum, stunt) => sum + stunt.duration, 0);
            elements.totalDuration.textContent = state.totalDuration;
            elements.totalTimeDisplay.textContent = formatTime(state.totalDuration);
        }

        function updateTimeDisplay() {
            elements.currentTimeDisplay.textContent = formatTime(state.currentTime);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showNotification(message, type) {
            elements.notificationText.textContent = message;
            elements.notification.className = `notification ${type} show`;
            setTimeout(() => {
                elements.notification.className = `notification ${type}`;
            }, 3000);
        }

        function calculateSafetyRating() {
            if (state.timeline.length === 0) return 100;
            const totalImpact = state.timeline.reduce((sum, stunt) => sum + stunt.safetyImpact, 0);
            const averageImpact = totalImpact / state.timeline.length;
            return Math.max(0, 100 - averageImpact);
        }

        function updateSafetyRating() {
            const rating = calculateSafetyRating();
            elements.safetyRating.textContent = `${Math.round(rating)}%`;
            const scale = rating / 100;
            elements.safetyMeterIndicator.style.transform = `scaleX(${scale})`;
            let safetyText, safetyClass;
            if (rating > 66) {
                safetyText = 'Safe';
                safetyClass = 'text-green-500';
            } else if (rating > 33) {
                safetyText = 'Moderate';
                safetyClass = 'text-yellow-500';
            } else {
                safetyText = 'Dangerous';
                safetyClass = 'text-red-500';
            }
            elements.safetyText.textContent = safetyText;
            elements.safetyText.className = `text-sm font-medium ${safetyClass}`;
        }

        function updateCharacterIndicators() {
            const currentStunt = state.timeline[state.currentStuntIndex];
            const actorCount = currentStunt ? currentStunt.actors || 1 : 0;
            elements.characterIndicators.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const indicator = document.createElement('span');
                indicator.className = `indicator ${i < actorCount ? 'active' : 'inactive'}`;
                elements.characterIndicators.appendChild(indicator);
            }
        }

        function createModal(content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
                    ${content}
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        // Public API
        window.app = {
            moveStuntUp,
            moveStuntDown,
            removeStunt
        };

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>